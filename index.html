// --- CONFIGURATION ---
// YOUR GOOGLE SHEET ID: 1Lx7uQGzaLJFYm8-AK3S1ZR90nrKyqGNvkrpe3iQzSPw
const SHEET_ID = '1Lx7uQGzaLJFYm8-AK3S1ZR90nrKyqGNvkrpe3iQzSPw'; 
const SHEET_NAME = 'Sheet1'; // Assuming your sheet tab name is the default 'Sheet1'
const EMAIL_RECIPIENT = 'info@terranovaengineeringlab.com';
const WEBSITE_URL = 'YOUR_TEAM_WEBSITE_URL'; // Replace this with your site's home page
// -----------------------


function doPost(e) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const data = e.parameter;

  // --- 1. PROCESS CHECKBOXES (New Motor Options) ---
  const newMotors = Array.isArray(data.new_motor) ? data.new_motor : (data.new_motor ? [data.new_motor] : []);

  // --- 2. BUILD THE ROW ARRAY FOR GOOGLE SHEET ---
  // NOTE: The order of this array MUST match the column headers in your Google Sheet!
  const row = [
    // Meta Data
    new Date(), 
    
    // Section 1: Rocket Redesign Log
    data.rocket_name,
    data.original_motor,
    newMotors.includes('C11-5') ? 'Yes' : 'No', // New Motor Options (checkboxes)
    newMotors.includes('D12-5') ? 'Yes' : 'No',
    newMotors.includes('E9-6') ? 'Yes' : 'No',
    newMotors.includes('Other') ? 'Yes' : 'No',
    data.other_motor_spec,
    data.recovery_system,
    data.other_recovery_spec,
    
    // Design Notes Table
    data.nc_original, data.nc_redesign,
    data.bt_original, data.bt_redesign,
    data.fins_original, data.fins_redesign,
    data.motor_original, data.motor_redesign,
    data.payload_original, data.payload_redesign,
    data.cgcp_original, data.cgcp_redesign,
    data.stability_original, data.stability_redesign,
    
    // Section 2: Simulation Results
    data.apogee,
    data.max_velocity,
    data.stability_cal,
    data.recovery_deployment,
    
    // Section 3: Egg Protection Lab - Materials Tested
    data.foam_drop_height, data.foam_result, data.foam_notes,
    data.bubble_drop_height, data.bubble_result, data.bubble_notes,
    data.print_drop_height, data.print_result, data.print_notes,
    data.other_material_name, data.other_drop_height, data.other_result, data.other_notes,
    
    // Sketch and Reflection
    data.sketch_notes,
    data.reflection_worked,
    data.reflection_change,
    data.reflection_relate
  ];

  // --- 3. APPEND DATA AND SEND EMAIL ---
  sheet.appendRow(row);

  MailApp.sendEmail({
    to: EMAIL_RECIPIENT,
    subject: `ðŸš€ NEW TARC ZENITH LOG: ${data.rocket_name || 'Untitled Entry'}`,
    htmlBody: buildEmailBody(data, newMotors)
  });

  // --- 4. RETURN SUCCESS PAGE ---
  return HtmlService.createHtmlOutput('<h2 style="color:#007bff; text-align:center;">Success! Notes submitted to the TerraNova Log.</h2><p style="text-align:center;"><a href="' + WEBSITE_URL + '">Click here to return to the Team Site</a></p>').setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}


// Function to build a nicely formatted HTML email (for info@terranovaengineeringlab.com)
function buildEmailBody(data, newMotors) {
  let html = `<h2 style="color:#007bff;">ðŸš€ TARC ZENITH Submission: ${data.rocket_name || 'Untitled Entry'}</h2>`;
  html += `<p><strong>Time:</strong> ${new Date().toLocaleString()}</p>`;
  
  html += `<h3 style="color:#28a745;">ðŸ”§ Section 1: Redesign Log</h3>`;
  html += `<ul>
    <li><strong>Original Motor:</strong> ${data.original_motor || 'N/A'}</li>
    <li><strong>New Motors Tested:</strong> ${newMotors.join(', ') || 'None'}</li>
    <li><strong>Recovery System:</strong> ${data.recovery_system || 'N/A'}</li>
  </ul>`;

  html += `<h4 style="border-bottom: 1px solid #ccc;">Design Changes Summary</h4>`;
  html += `<p><strong>Nose Cone Redesign:</strong> ${data.nc_redesign || 'No Change'}</p>`;
  html += `<p><strong>Stability Margin Redesign:</strong> ${data.stability_original || 'N/A'} -> ${data.stability_redesign || 'N/A'}</p>`;
  
  html += `<h3 style="color:#28a745;">ðŸ’¬ Reflection Summary</h3>`;
  html += `<p><strong>What worked best?</strong> ${data.reflection_worked || 'No Entry'}</p>`;
  html += `<p><strong>How does this relate to payload?</strong> ${data.reflection_relate || 'No Entry'}</p>`;

  html += `<p style="margin-top: 20px; font-style: italic;">Full details are available in the Google Sheet log.</p>`;

  return html;
}
